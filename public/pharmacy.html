<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MediCare - Patient Management</title>
  <style>
    :root {
      --primary: #3a86ff;
      --primary-dark: #2667cc;
      --accent: #ff6b6b;
      --success: #4CAF50;
      --warning: #FFC107;
      --light: #f8fafc;
      --dark: #334155;
      --gray: #94a3b8;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .navbar {
      background-color: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 15px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .logo {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logo-icon {
      font-size: 28px;
    }
    
    .nav-links {
      display: flex;
      gap: 20px;
    }
    
    .nav-link {
      text-decoration: none;
      color: var(--dark);
      font-weight: 500;
      padding: 5px 10px;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    .nav-link:hover {
      background-color: rgba(58, 134, 255, 0.1);
      color: var(--primary);
    }
    
    .nav-link.active {
      background-color: rgba(58, 134, 255, 0.1);
      color: var(--primary);
    }
    
    main {
      flex: 1;
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }
    
    h1 {
      color: var(--dark);
      margin-bottom: 30px;
      font-weight: 600;
      text-align: center;
    }
    
    .container {
      width: 100%;
      max-width: 1000px;
      display: flex;
      flex-direction: column;
      gap: 30px;
    }
    
    .card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      padding: 30px;
      width: 100%;
    }
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .card-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card-icon {
      color: var(--primary);
      font-size: 24px;
    }
    
    .search-box {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    input[type="text"],
    input[type="number"],
    input[type="datetime-local"],
    select {
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ddd;
      transition: border 0.3s ease;
    }
    
    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    button {
      padding: 12px 24px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }
    
    button:hover {
      background-color: var(--primary-dark);
    }
    
    button.secondary {
      background-color: #e2e8f0;
      color: var(--dark);
    }
    
    button.secondary:hover {
      background-color: #cbd5e1;
    }
    
    button.danger {
      background-color: var(--accent);
    }
    
    button.danger:hover {
      background-color: #e74c3c;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .form-label {
      font-weight: 500;
      font-size: 14px;
      color: var(--gray);
    }
    
    .patients-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .patient-card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      padding: 20px;
      border-left: 4px solid var(--primary);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
    }
    
    .patient-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }
    
    .patient-name {
      font-weight: 600;
      font-size: 18px;
      margin-bottom: 5px;
    }
    
    .patient-id {
      color: var(--gray);
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .patient-info {
      font-size: 14px;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .patient-info-icon {
      color: var(--primary);
    }
    
    .medical-history {
      margin-top: 20px;
    }
    
    .medical-record {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid var(--primary);
    }
    
    .record-title {
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
    }
    
    .record-date {
      color: var(--gray);
      font-size: 14px;
    }
    
    .record-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    
    .record-item {
      margin-bottom: 5px;
    }
    
    .record-label {
      font-weight: 500;
      font-size: 14px;
      color: var(--gray);
    }
    
    .record-value {
      font-weight: 500;
    }
    
    .interaction-item {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid var(--primary);
    }
    
    .test-result {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      background-color: rgba(58, 134, 255, 0.1);
      color: var(--primary);
      margin-right: 5px;
      margin-bottom: 5px;
    }
    
    .prescription-item {
      background-color: rgba(76, 175, 80, 0.1);
      color: var(--success);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      margin-right: 5px;
      margin-bottom: 5px;
      display: inline-block;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      background-color: #e2e8f0;
      color: var(--dark);
      white-space: nowrap;
    }
    
    .tab.active {
      background-color: var(--primary);
      color: white;
    }
    
    .tab-content {
      display: none;
      
    }
    
    .tab-content.active {
      display: block;
      /* display: flex;
      justify-content: center; /* Center horizontally */
      /* align-items: center;  */ 
    }

    
    
    .error {
      color: var(--accent);
      margin-top: 20px;
      text-align: center;
      font-weight: 500;
    }
    
    .empty-state {
      text-align: center;
      padding: 30px;
      color: var(--gray);
    }
    
    .empty-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    
    th, td {
      text-align: left;
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }
    
    th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: var(--dark);
    }
    
    tr:hover {
      background-color: #f8f9fa;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      background-color: rgba(58, 134, 255, 0.1);
      color: var(--primary);
    }
    
    footer {
      background-color: white;
      padding: 20px 40px;
      text-align: center;
      color: var(--gray);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      margin-top: auto;
    }
    
    .footer-text {
      font-size: 14px;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      padding: 30px;
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .close {
      color: var(--gray);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: var(--dark);
    }
    
    .modal-footer {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .page-tabs {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    
    .page-tab {
      text-decoration: none;
      color: var(--gray);
      font-weight: 600;
      padding-bottom: 10px;
      position: relative;
      white-space: nowrap;
    }
    
    .page-tab.active {
      color: var(--primary);
    }
    
    .page-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background-color: var(--primary);
      border-radius: 3px;
    }
    
    .page-view {
      display: none;
    }
    
    .page-view.active {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Top Navigation Bar -->
  <div class="navbar">
    <div class="logo">
      <span class="logo-icon">‚öïÔ∏è</span>
      <span>MediCare</span>
    </div>
    <div class="nav-links">
        <a href="home.html" class="nav-link">Home</a>
        <a href="patient.html" class="nav-link">Patients</a>
        <a href="appointment.html" class="nav-link">Appointment</a>
        <a href="doctor.html" class="nav-link">Doctors</a>
        <a href="#" class="nav-link active">Pharmacy</a>
        <a href="lab.html" class="nav-link">Labs</a>
      </div>
  </div>

  <!-- Main Content -->
  <main>
    <h1>Pharmacy Management</h1>
    
    <div class="page-tabs">
      <a href="#" class="page-tab active" data-page="all-prescription">All Prescription</a>
      <a href="#" class="page-tab" data-page="medicine-search">Search medicine</a>
      <a href="#" class="page-tab" data-page="pharm-stock">Pharmacy stock</a>
      <a href="#" class="page-tab" data-page="update-quantity">update quantity</a>
      <a href="#" class="page-tab" data-page="report">Report</a>
      <a href="#" class="page-tab" data-page="universal">Availability</a>
      <a href="#" class="page-tab" data-page="med">Medicines prescription</a>
    </div>
    
    <div class="container">
      <!-- All Patients View -->
      <div class="page-view active" id="all-prescription">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <span class="card-icon">üë•</span>
                    All Prescriptions
                </h2>
                <div class="search-box">
                    <input type="text" id="patientSearchInput" placeholder="Search prescription...">
                    <button class="secondary" onclick="searchPrescriptions()">Search</button>
                </div>
            </div>
    
            <div id="patientsList" class="patients-list">
                <!-- Prescriptions will be listed here -->
                <div class="empty-state">
                    <div class="empty-icon">üîÑ</div>
                    <p>Loading prescriptions...</p>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        /* Basic styling for the prescription list */
        #patientsList {
            padding: 10px;
        }
    
        #patientsList .prescription-item {
            border: 1px solid #ddd;
            padding: 8px;
            margin-bottom: 5px;
        }
    </style>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const patientsList = document.getElementById('patientsList');
            let allPrescriptions = []; // Store all fetched prescriptions
    
            async function fetchAllPrescriptions() {
                patientsList.innerHTML = `<div class="empty-state">
                  <div class="empty-icon">üîÑ</div>
                  <p>Loading prescriptions...</p>
              </div>`; // Loading indicator
    
                try {
                    const response = await fetch('http://localhost:3000/api/prescriptions/prescription');
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
    
                    const data = await response.json();
                    console.log("API Response:", data);
                    allPrescriptions = data; // Store all the data from API
    
                    displayPrescriptions(data);
                } catch (error) {
                    console.error('Error fetching prescriptions:', error);
                    patientsList.innerHTML = `<p style="color: red;">Error fetching data: ${error.message}</p>`;
                }
            }
    
            function displayPrescriptions(prescriptions) {
                if (prescriptions && prescriptions.length > 0) {
                    let html = '';
                    prescriptions.forEach(prescription => {
                        html += `<div class="prescription-item">
                              <strong>Prescription ID:</strong> ${prescription.prescription_id || 'N/A'}<br>
                              <strong>Dosage:</strong> ${prescription.dosage || 'N/A'}<br>
                              <strong>Medicines:</strong> ${prescription.medicine_names || 'N/A'}<br>
                              <strong>Duration:</strong> ${prescription.duration || 'N/A'}
                            </div>`;
                    });
                    patientsList.innerHTML = html;
                } else {
                    patientsList.innerHTML = "<p>No prescriptions found.</p>";
                }
            }
           window.searchPrescriptions =  async function () {
                const searchTerm = document.getElementById('patientSearchInput').value.toLowerCase();
                    // Load after API calls, allPrescriptions will be properly used
                if (!allPrescriptions) {
                     patientsList.innerHTML = "Loading Data";
                }
    
                const filteredPrescriptions = allPrescriptions.filter(prescription => {
                    return (prescription.prescription_id && prescription.prescription_id.toString().toLowerCase().includes(searchTerm)) ||
                        (prescription.dosage && prescription.dosage.toLowerCase().includes(searchTerm)) ||
                        (prescription.medicine_names && prescription.medicine_names.toLowerCase().includes(searchTerm)) ||
                        (prescription.duration && prescription.duration.toLowerCase().includes(searchTerm));
                });
    
                displayPrescriptions(filteredPrescriptions);
                console.log("Called");
                }
    
            // Call API to load when deployed
            fetchAllPrescriptions();
        });
    
    </script>    
      <!-- Medical History View -->
      <div class="page-view" id="medicine-search">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <span class="card-icon">üìã</span>
              Medicine Search
            </h2>
          </div>
          <div class="search-box">
            <input type="number" id="medicineSearch" placeholder="Enter medicine ID">
            <button onclick="getMedicalHistory()">Get Medicine List</button>
          </div>
      
          <div id="medicalHistoryContent" class="medical-history" style="display:none;">
            <!-- Medical history content will be loaded here -->
            <input type="text" id="dynamicSearch" placeholder="Search within results" onkeyup="dynamicSearch()" style="display:none;">
            <ul id="medicineList"></ul>
          </div>
      
          <div id="medicalHistoryError" class="error" style="display:none;"></div>
        </div>
      
        <style>
          .medicine-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
          }
      
          .medicine-item:last-child {
            border-bottom: none;
          }
        </style>
      
        <script>
          let allMedicines = []; // Store all fetched medicines
          let filteredMedicines = []; // Store filtered medicines for dynamic search
      
          async function getMedicalHistory() {
            const medicineId = document.getElementById('medicineSearch').value;
            const medicalHistoryContent = document.getElementById('medicalHistoryContent');
            const medicalHistoryError = document.getElementById('medicalHistoryError');
            const medicineList = document.getElementById('medicineList');
            const dynamicSearchInput = document.getElementById('dynamicSearch');
      
            medicalHistoryContent.style.display = 'none';
            medicalHistoryError.style.display = 'none';
            medicineList.innerHTML = ''; // Clear previous results
      
            try {
              const response = await fetch('http://localhost:3000/api/pharmacy/all-name');
              if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
              }
      
              const data = await response.json();
              allMedicines = data;  // Store all medicines
              
              if (medicineId) {
                  filteredMedicines = allMedicines.filter(medicine => medicine.medicine_id == medicineId);
              } else {
                  filteredMedicines = [...allMedicines];
              }
      
              if (filteredMedicines.length > 0) {
                medicalHistoryContent.style.display = 'block';
                dynamicSearchInput.style.display = 'block';
                displayMedicines(filteredMedicines);
              } else {
                medicalHistoryError.style.display = 'block';
                medicalHistoryError.textContent = 'No medicines found.';
              }
            } catch (error) {
              console.error('Error fetching data:', error);
              medicalHistoryError.style.display = 'block';
              medicalHistoryError.textContent = 'Error fetching data. Please try again.';
            }
          }
      
          function displayMedicines(medicines) {
            const medicineList = document.getElementById('medicineList');
            medicineList.innerHTML = '';
      
            medicines.forEach(medicine => {
              const listItem = document.createElement('li');
              listItem.classList.add('medicine-item');
              listItem.innerHTML = `
                <strong>Name:</strong> ${medicine.name}<br>
                <strong>Manufacturer:</strong> ${medicine.manufacturer}<br>
                <strong>Price:</strong> ${medicine.price}<br>
                <strong>Dosage:</strong> ${medicine.dosage}
              `;
              medicineList.appendChild(listItem);
            });
          }
      
          function dynamicSearch() {
            const searchTerm = document.getElementById('dynamicSearch').value.toLowerCase();
            filteredMedicines = allMedicines.filter(medicine => {
              return (
                medicine.name.toLowerCase().includes(searchTerm) ||
                medicine.manufacturer.toLowerCase().includes(searchTerm) ||
                medicine.price.toLowerCase().includes(searchTerm) ||
                medicine.dosage.toLowerCase().includes(searchTerm)
              );
            });
      
            displayMedicines(filteredMedicines);
          }
      
        </script>
      </div>


      <div class="page-view" id="pharm-stock">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <span class="card-icon">üìã</span>
                    Pharmacy Stock
                </h2>
            </div>
    
            <div class="search-box">
                <label for="pharmacyId">Pharmacy ID:</label>
                <input type="number" id="pharmacyId" placeholder="Enter pharmacy ID">
    
                <label>
                    <input type="checkbox" id="lowStockToggle" onchange="toggleThreshold()"> Low Stock
                </label>
    
                <input type="number" id="thresholdInput" placeholder="Enter max quantity" style="display: none;">
    
                <button onclick="fetchStock()">Get Stock</button>
            </div>
    
            <div id="stockError" class="error" style="display: none;"></div>
            <div id="stockResults" class="medical-history" style="display: none;"></div>
        </div>
    </div>
    
    <style>
        #stockResults table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
    
        #stockResults th,
        #stockResults td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
    
        #stockResults th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
    
        #stockError {
            color: red;
            margin-top: 10px;
        }
    </style>
    
    <script>
        function toggleThreshold() {
            const checkbox = document.getElementById('lowStockToggle');
            const thresholdInput = document.getElementById('thresholdInput');
            thresholdInput.style.display = checkbox.checked ? 'inline-block' : 'none';
        }
    
        async function fetchStock() {
            const pharmacyId = document.getElementById('pharmacyId').value;
            const isLowStock = document.getElementById('lowStockToggle').checked;
            const threshold = document.getElementById('thresholdInput').value;
            const resultsDiv = document.getElementById('stockResults');
            const errorDiv = document.getElementById('stockError');
    
            resultsDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            resultsDiv.innerHTML = '<p>Loading stock data...</p>';
            resultsDiv.style.display = 'block';
    
            if (!pharmacyId) {
                resultsDiv.style.display = 'none';
                errorDiv.textContent = "Please enter a Pharmacy ID.";
                errorDiv.style.display = 'block';
                return;
            }
    
            try {
                const response = await fetch(`http://localhost:3000/api/pharmacy/${pharmacyId}/stock`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                let data = await response.json();
    
                if (isLowStock) {
                    if (!threshold) {
                        resultsDiv.style.display = 'none';
                        errorDiv.textContent = "Please enter a threshold quantity.";
                        errorDiv.style.display = 'block';
                        return;
                    }
                    data = data.filter(item => parseInt(item.quantity) < parseInt(threshold));
                }
    
                if (data.length === 0) {
                    resultsDiv.innerHTML = '<p>No matching stock found.</p>';
                    return;
                }
    
                let html = `<table>
                                <thead><tr><th>Medicine Name</th><th>Quantity</th></tr></thead>
                                <tbody>`;
                data.forEach(item => {
                    html += `<tr><td>${item.name || 'N/A'}</td><td>${item.quantity || 'N/A'}</td></tr>`;
                });
                html += '</tbody></table>';
    
                resultsDiv.innerHTML = html;
    
            } catch (err) {
                resultsDiv.style.display = 'none';
                errorDiv.textContent = "Failed to fetch stock: " + err.message;
                errorDiv.style.display = 'block';
            }
        }
    </script>
    
      
      <!-- Patient-Doctor Interactions View -->
      <div class="page-view" id="update-quantity">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <span class="card-icon">ü©∫</span>
                    Update Stock by 100
                </h2>
            </div>
            <div class="search-box">
                <label for="pharmacyId">Pharmacy ID:</label>
                <input type="number" id="pharmacyId" placeholder="Enter pharmacy ID">
    
                <label for="medicineId">Medicine ID:</label>
                <input type="number" id="medicineId" placeholder="Enter medicine ID">
    
                <button onclick="updateStock()">Add 100 to Stock</button>
            </div>
    
            <div id="interactionsContent" style="display:none;">
                <!-- Interactions will be listed here -->
            </div>
    
            <div id="interactionsError" class="error" style="display:none;"></div>
        </div>
    </div>
    
    <style>
    /* Basic styling for the update quantity section */
    .search-box label {
        display: block;
        margin-top: 5px;
    }
    
    .search-box input[type="number"] {
        margin-bottom: 10px;
    }
    
    #interactionsContent {
        margin-top: 10px;
    }
    
    #interactionsError {
        color: red;
        margin-top: 10px;
    }
    </style>
    
    <script>
    async function updateStock() {
      const pharmacyId = document.getElementById('pharmacyId').value;
      const medicineId = document.getElementById('medicineId').value;
      const interactionsContent = document.getElementById('interactionsContent');
      const interactionsError = document.getElementById('interactionsError');
    
      // Clear previous content and error messages
      interactionsContent.style.display = 'none';
      interactionsError.style.display = 'none';
      interactionsContent.innerHTML = '';
    
      // Validate inputs
      if (!pharmacyId || !medicineId) {
        interactionsError.textContent = 'Please enter Pharmacy ID and Medicine ID.';
        interactionsError.style.display = 'block';
        return;
      }
    
      try {
        // Construct the API URL
        const apiUrl = `http://localhost:3000/api/pharmacy/${pharmacyId}/medicine/${medicineId}`;
        console.log("apiUrl", apiUrl) //Test
        // Make the API request to update the stock
    
        const response = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          }
        });
    
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
    
        const data = await response.json();
         console.log("Succes!");
        // Display success message
        interactionsContent.textContent = `Stock updated successfully for Pharmacy ID ${pharmacyId} and Medicine ID ${medicineId}. 100 has been added.`;
        interactionsContent.style.display = 'block';
    
      } catch (error) {
        console.error('Error updating stock:', error);
        interactionsError.textContent = `Error updating stock: ${error.message}`;
        interactionsError.style.display = 'block';
      }
    }
    </script>      
      <!-- MRI Patients View -->
      <div class="page-view" id="report">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <span class="card-icon">üî¨</span>
                    Report
                </h2>
            </div>
    
            <table>
                <thead>
                <tr>
                    <th>Month</th>
                    <th>No of Prescription</th>
                </tr>
                </thead>
                <tbody id="mriPatientsTable">
                <tr>
                    <td colspan="2" class="empty-state">
                        <div class="empty-icon">üîÑ</div>
                        <p>Loading data...</p>
                    </td>
                </tr>
                </tbody>
            </table>
    
            <div id="mriPatientsError" class="error" style="display:none;"></div>
        </div>
    </div>
    
    <style>
        /* Basic table styles */
        #mriPatientsTable tr.empty-state {
            text-align: center;
        }
    
        #mriPatientsTable td {
            padding: 8px;
            border: 1px solid #ddd;
        }
    
        #mriPatientsTable th {
            background-color: #f2f2f2;
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
    
        #mriPatientsError {
            color: red;
            margin-top: 10px;
        }
    
        /* Add this if you want specific style for "loading" or "empty" state icon */
        .empty-icon {
            font-size: 2em; /* Adjust size as needed */
        }
    </style>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mriPatientsTable = document.getElementById('mriPatientsTable');
            const mriPatientsError = document.getElementById('mriPatientsError');
    
            async function fetchReportData() {
                mriPatientsTable.innerHTML = `<tr>
                    <td colspan="2" class="empty-state">
                        <div class="empty-icon">üîÑ</div>
                        <p>Loading data...</p>
                    </td>
                </tr>`;
                mriPatientsError.style.display = 'none';
    
                try {
                    const response = await fetch('http://localhost:3000/api/reports/monthly-prescription-analysis');
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
    
                    const data = await response.json();
                    console.log("API Response:", data);
    
                    mriPatientsTable.innerHTML = ''; // Clear "Loading" row
    
                    if (data && data.length > 0) {
                        data.forEach(reportItem => {
                            const row = mriPatientsTable.insertRow();
                            const monthCell = row.insertCell();
                            const prescriptionCountCell = row.insertCell();
    
                            monthCell.textContent = reportItem.month || 'N/A';
                            prescriptionCountCell.textContent = reportItem.totalprescriptions || 'N/A';
                        });
                    } else {
                        mriPatientsTable.innerHTML = `<tr>
                            <td colspan="2" class="empty-state">
                                <p>No data found.</p>
                            </td>
                        </tr>`;
                    }
                } catch (error) {
                    console.error('Error fetching report data:', error);
                    mriPatientsTable.innerHTML = ''; // Clear any existing data
                    mriPatientsError.textContent = `Error fetching data: ${error.message}`;
                    mriPatientsError.style.display = 'block';
                }
            }
    
            fetchReportData();
        });
    </script>



<div class="page-view" id="universal">
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <span class="card-icon">üë•</span>
        All Global Medicine
      </h2>
      <div class="search-box">
        <input type="text" id="patientSearchInput" placeholder="Search medicine...">
        <button onclick="searchMedicines()">Search</button>
      </div>
    </div>

    <div id="patientsList" class="patients-list">
      <!-- Medicines will be listed here -->
      <div class="empty-state" id="loadingState">
        <div class="empty-icon">üîÑ</div>
        <p>Loading medicines...</p>
      </div>
      <table id="medicineTable" style="display:none;">
        <thead>
          <tr>
            <th>Medicine ID</th>
            <th>Name</th>
            <th>Manufacturer</th>
            <th>Dosage</th>
            <th>Price</th>
          </tr>
        </thead>
        <tbody id="medicineTableBody">
          <!-- Table rows will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
  /* Styles for all global medicine section */
  #patientsList {
    padding: 10px;
  }

  #patientsList .medicine-item {
    border: 1px solid #ddd;
    padding: 8px;
    margin-bottom: 5px;
  }

  /* Style the table */
  #medicineTable {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }

  #medicineTable th,
  #medicineTable td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }

  #medicineTable th {
    background-color: #f2f2f2;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const patientsList = document.getElementById('patientsList');
    const patientSearchInput = document.getElementById('patientSearchInput');
    const loadingState = document.getElementById('loadingState');
    const medicineTable = document.getElementById('medicineTable');
    const medicineTableBody = document.getElementById('medicineTableBody');

    let allMedicines = []; // Store all fetched medicines
    let filteredMedicines = []; // Store medicines after search

    async function fetchMedicines() {
      loadingState.style.display = 'block'; //Show the loading message

      try {
        const response = await fetch('http://localhost:3000/api/pharmacy/medicines/available-everywhere');
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        allMedicines = await response.json();
        filteredMedicines = [...allMedicines]; // Initially show all medicines

        loadingState.style.display = 'none'; // Hide loading message
        displayMedicines(filteredMedicines); //Display the initial list in the table


      } catch (error) {
        console.error('Error fetching medicines:', error);
        patientsList.innerHTML = `<p style="color: red;">Error fetching data: ${error.message}</p>`;
      }
    }

    function displayMedicines(medicines) {
      medicineTableBody.innerHTML = ""; // Clear existing table rows

      if (medicines.length > 0) {
        medicines.forEach(medicine => {
          const row = medicineTableBody.insertRow();
          const medicineIdCell = row.insertCell();
          const nameCell = row.insertCell();
          const manufacturerCell = row.insertCell();
          const dosageCell = row.insertCell();
          const priceCell = row.insertCell();

          medicineIdCell.textContent = medicine.medicine_id;
          nameCell.textContent = medicine.name;
          manufacturerCell.textContent = medicine.manufacturer;
          dosageCell.textContent = medicine.dosage;
          priceCell.textContent = medicine.price;
        });
        medicineTable.style.display = 'table'; // Show the table
      } else {
        medicineTableBody.innerHTML = '<tr><td colspan="5">No medicines found.</td></tr>';
        medicineTable.style.display = 'table'; //Show the table (with message)
      }
    }

    window.searchMedicines = function() {
      const searchTerm = patientSearchInput.value.toLowerCase();
      filteredMedicines = allMedicines.filter(medicine =>
        medicine.name.toLowerCase().includes(searchTerm) // Search by medicine name
      );

      displayMedicines(filteredMedicines);
    }

    // Initial fetch
    fetchMedicines();
  });
</script>

<div class="page-view" id="med">
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <span class="card-icon">üî¨</span>
        Report
      </h2>
    </div>
    <button onclick="fetchPrescriptionCounts()">Generate Report</button>
    <table>
      <thead>
        <tr>
          <th>Medicine Name</th>
          <th>No of Prescriptions</th>
        </tr>
      </thead>
      <tbody id="prescriptionTableBody">
        <tr>
          <td colspan="2" class="empty-state">
            <div class="empty-icon">üîÑ</div>
            <p>Click "Generate Report" to load data.</p>
          </td>
        </tr>
      </tbody>
    </table>

    <div id="prescriptionError" class="error" style="display:none; color:red;"></div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tableBody = document.getElementById('prescriptionTableBody');
    const errorBox = document.getElementById('prescriptionError');

    window.fetchPrescriptionCounts = async function () {
      try {
        // Show loading state
        tableBody.innerHTML = `
          <tr>
            <td colspan="2" class="empty-state">
              <div class="empty-icon">üîÑ</div>
              <p>Loading data...</p>
            </td>
          </tr>`;
        errorBox.style.display = 'none';

        const response = await fetch('http://localhost:3000/api/prescriptions/prescription/count');
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();

        if (data.length > 0) {
          tableBody.innerHTML = ''; // Clear loading/empty state

          data.forEach(item => {
            const row = tableBody.insertRow();
            row.insertCell().textContent = item.medicine_name;
            row.insertCell().textContent = item.prescription_count;
          });
        } else {
          tableBody.innerHTML = `
            <tr>
              <td colspan="2" class="empty-state">
                <div class="empty-icon">üì≠</div>
                <p>No data found.</p>
              </td>
            </tr>`;
        }
      } catch (error) {
        console.error('Error fetching data:', error);
        errorBox.style.display = 'block';
        errorBox.textContent = `Error fetching data: ${error.message}`;
        tableBody.innerHTML = '';
      }
    };
  });
</script>

    </div>
    
  </main>
  
  <!-- Patient Details Modal -->
  <div id="patientModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalPatientName">Patient Details</h2>
        <span class="close" onclick="closePatientModal()">&times;</span>
      </div>
      <div id="modalContent">
        <!-- Patient details will be loaded here -->
      </div>
      <div class="modal-footer">
        <button class="secondary" onclick="closePatientModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <p class="footer-text">¬© 2025 MediCare Health Services. All rights reserved.</p>
  </footer>
  
  <script>
    // Base API URL
    const API_URL = 'http://localhost:3000/api';
    
    // Page Navigation
    document.querySelectorAll('.page-tab').forEach(tab => {
      tab.addEventListener('click', function(e) {
        e.preventDefault();
        const targetPage = this.getAttribute('data-page');
        
        // Reset all tabs and pages
        document.querySelectorAll('.page-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
        
        // Activate selected tab and page
        this.classList.add('active');
        document.getElementById(targetPage).classList.add('active');
        
        // Load data if needed
        if (targetPage === 'all-patients') {
          loadAllPatients();
        } else if (targetPage === 'mri-patients') {
          loadMRIPatients();
        }
      });
    });
    
    // Tab Switching
    function switchTab(tabId, tabElement) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
       
      // Show selected tab
      document.getElementById(tabId).classList.add('active');
      tabElement.classList.add('active');
    }
    
    // Load All Patients
    async function loadAllPatients() {
      try {
        const response = await fetch(`${API_URL}/patients`);
        if (!response.ok) {
          throw new Error('Failed to load patients');
        }
        
        const patients = await response.json();
        const patientsListElement = document.getElementById('patientsList');
        
        if (patients.length === 0) {
          patientsListElement.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üìù</div>
              <p>No patients found.</p>
            </div>
          `;
          return;
        }
        
        let html = '';
        patients.forEach(patient => {
          html += `
            <div class="patient-card" onclick="openPatientModal(${patient.patient_id})">
              <div class="patient-name">${patient.name}</div>
              <div class="patient-id">ID: ${patient.patient_id}</div>
              <div class="patient-info">
                <span class="patient-info-icon">üìß</span> ${patient.email || 'No email'}
              </div>
              <div class="patient-info">
                <span class="patient-info-icon">üì±</span> ${patient.phone || 'No phone'}
              </div>
            </div>
          `;
        });
        
        patientsListElement.innerHTML = html;
      } catch (error) {
        console.error('Error loading patients:', error);
        document.getElementById('patientsList').innerHTML = `
          <div class="error">
            Failed to load patients. Please try again later.
          </div>
        `;
      }
    }
    
    // Get Patient Details
    async function getPatientDetails() {
      const patientId = document.getElementById('patientIdForDetails').value;
      
      if (!patientId) {
        document.getElementById('patientDetailsError').textContent = 'Please enter a Patient ID';
        document.getElementById('patientDetailsError').style.display = 'block';
        document.getElementById('patientDetailsContent').style.display = 'none';
        return;
      }
      
      try {
        const response = await fetch(`${API_URL}/patients/${patientId}/details`);
        if (!response.ok) {
          throw new Error('Patient not found or error retrieving data');
        }
        
        const patientDetails = await response.json();
        if (patientDetails.length === 0) {
          document.getElementById('patientDetailsError').textContent = 'No details found for this patient';
          document.getElementById('patientDetailsError').style.display = 'block';
          document.getElementById('patientDetailsContent').style.display = 'none';
          return;
        }
        
        // Reset error and display content
        document.getElementById('patientDetailsError').style.display = 'none';
        document.getElementById('patientDetailsContent').style.display = 'block';
        
        // Set patient name
        document.getElementById('patientName').textContent = patientDetails[0].patient_name || 'Unknown Patient';
        document.getElementById('patientId').textContent = `ID: ${patientId}`;
        
        // Populate lab tests
        const labTestsTable = document.getElementById('labTestsTable');
        const uniqueTests = [...new Map(patientDetails
          .filter(item => item.test_id) // Filter out null test_id entries
          .map(item => [item.test_id, item]))
          .values()];
        
        if (uniqueTests.length === 0) {
          labTestsTable.innerHTML = '<tr><td colspan="3">No lab tests found</td></tr>';
        } else {
          labTestsTable.innerHTML = uniqueTests.map(test => `
            <tr>
              <td>${test.test_id}</td>
              <td>${test.test_type || 'Unknown'}</td>
              <td>${test.result || 'Pending'}</td>
            </tr>
          `).join('');
        }
        
        // Populate prescriptions
        const prescriptionsTable = document.getElementById('prescriptionsTable');
        const uniquePrescriptions = [...new Map(patientDetails
          .filter(item => item.prescription_id) // Filter out null prescription_id entries
          .map(item => [item.prescription_id, item]))
          .values()];
        
        if (uniquePrescriptions.length === 0) {
          prescriptionsTable.innerHTML = '<tr><td colspan="2">No prescriptions found</td></tr>';
        } else {
          prescriptionsTable.innerHTML = uniquePrescriptions.map(prescription => `
            <tr>
              <td>${prescription.prescription_id}</td>
              <td>${prescription.medicines || 'None'}</td>
            </tr>
          `).join('');
        }
        
      } catch (error) {
        console.error('Error getting patient details:', error);
        document.getElementById('patientDetailsError').textContent = 'Failed to retrieve patient details';
        document.getElementById('patientDetailsError').style.display = 'block';
        document.getElementById('patientDetailsContent').style.display = 'none';
      }
    };
  </script>
</body>
</html>